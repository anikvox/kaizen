generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String            @id @default(cuid())
  clerkId         String            @unique
  email           String            @unique
  name            String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  deviceTokens    DeviceToken[]
  websiteVisits   WebsiteVisit[]
  textAttentions  TextAttention[]
  imageAttentions ImageAttention[]
  audioAttentions AudioAttention[]
  youtubeAttentions YoutubeAttention[]
  settings        UserSettings?
  chatSessions    ChatSession[]
  focuses         Focus[]
  quizzes         Quiz[]
  quizResults     QuizResult[]

  @@map("users")
}

model DeviceToken {
  id        String   @id @default(cuid())
  token     String   @unique
  name      String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  lastUsedAt DateTime?

  @@map("device_tokens")
}

model WebsiteVisit {
  id            String    @id @default(cuid())
  url           String
  title         String
  metadata      Json      @default("{}")
  openedAt      DateTime
  closedAt      DateTime?
  activeTime    Int       @default(0) // in milliseconds
  referrer      String?
  summary       String?   @db.Text // AI-generated summary of text attention
  imageSummary  String?   @db.Text // AI-generated summary of image attention
  summarizedAt  DateTime? // Last time summary was generated
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([userId, url, openedAt])
  @@index([userId])
  @@index([url])
  @@map("website_visits")
}

model TextAttention {
  id        String   @id @default(cuid())
  url       String
  text      String   @db.Text
  wordsRead Int
  timestamp DateTime
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([url])
  @@index([timestamp])
  @@map("text_attentions")
}

model ImageAttention {
  id            String    @id @default(cuid())
  url           String
  src           String
  alt           String
  title         String
  width         Int
  height        Int
  hoverDuration Int       // in milliseconds
  confidence    Int       // 0-100
  timestamp     DateTime
  summary       String?   @db.Text // AI-generated description of the image
  summarizedAt  DateTime? // Last time summary was generated
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([url])
  @@index([timestamp])
  @@map("image_attentions")
}

model AudioAttention {
  id               String   @id @default(cuid())
  url              String
  src              String
  title            String
  duration         Float    // in seconds
  playbackDuration Int      // in milliseconds
  currentTime      Float    // in seconds
  confidence       Int      // 0-100
  timestamp        DateTime
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt        DateTime @default(now())

  @@index([userId])
  @@index([url])
  @@index([timestamp])
  @@map("audio_attentions")
}

model YoutubeAttention {
  id              String   @id @default(cuid())
  videoId         String?
  event           String   // "opened" | "caption" | "active-watch-time-update"
  title           String?
  channelName     String?
  url             String?
  caption         String?  @db.Text
  activeWatchTime Int?     // in milliseconds
  timestamp       DateTime
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([videoId])
  @@index([timestamp])
  @@map("youtube_attentions")
}

model UserSettings {
  id                            String   @id @default(cuid())
  userId                        String   @unique
  user                          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Current Active Tab (synced from extension)
  currentActiveUrl              String?
  currentActiveTitle            String?
  currentActiveAt               DateTime?
  // User Location (set by user via chat)
  location                      String?  // City name, e.g., "Tokyo", "New York"
  timezone                      String?  // Derived from location, e.g., "Asia/Tokyo"
  // Translation Preferences
  preferredTranslationLanguage  String?  // User's preferred language for translations, e.g., "Spanish", "French"
  // Cognitive Attention Settings
  cognitiveAttentionDebugMode   Boolean  @default(false)
  cognitiveAttentionShowOverlay Boolean  @default(false)
  attentionTrackingIgnoreList   String?  @db.Text // Newline-separated list of URL patterns/regexes to ignore
  // Summarization Settings
  attentionSummarizationEnabled Boolean  @default(true)
  attentionSummarizationIntervalMs Int   @default(60000) // Default 1 minute
  lastSummarizationCalculatedAt DateTime?                // Marker for last summarization run (per-user interval)
  // Focus Calculation Settings
  focusCalculationEnabled       Boolean  @default(true)
  focusCalculationIntervalMs    Int      @default(30000)   // Default 30 seconds
  focusInactivityThresholdMs    Int      @default(60000)   // Default 1 minute
  focusMinDurationMs            Int      @default(30000)   // Default 30 seconds (minimum before drift can create new focus)
  lastFocusCalculatedAt         DateTime?                  // Marker for last focus calculation (to avoid reprocessing attention)
  // LLM Settings
  llmProvider                   String?  // "gemini" | "anthropic" | "openai" | null (system default)
  llmModel                      String?  // Selected model for the provider
  geminiApiKeyEncrypted         String?  @db.Text
  anthropicApiKeyEncrypted      String?  @db.Text
  openaiApiKeyEncrypted         String?  @db.Text
  // Quiz Settings
  quizAnswerOptionsCount        Int      @default(2)    // 2, 3, or 4 answer options per question
  quizActivityDays              Int      @default(3)    // 1-7 days of activity to use for quiz
  // Pomodoro Settings
  pomodoroCooldownMs            Int      @default(120000) // Default 2 minutes - inactivity before timer resets
  // Focus Agent Settings
  focusAgentEnabled             Boolean  @default(true)   // Enable/disable the autonomous focus guardian
  focusAgentSensitivity         Float    @default(0.5)    // 0-1, learned from feedback
  focusAgentLastRunAt           DateTime?                 // Last time the agent ran for this user
  focusAgentCooldownMs          Int      @default(300000) // Default 5 minutes between nudges
  focusAgentIntervalMs          Int      @default(60000)  // Default 1 minute - how often to run the agent
  // Theme settings
  themeMode                     String   @default("light") // "light" | "dark"
  createdAt                     DateTime @default(now())
  updatedAt                     DateTime @updatedAt

  pomodoro                      PomodoroSession?

  @@map("user_settings")
}

model PomodoroSession {
  id                 String   @id @default(cuid())
  userId             String   @unique
  settings           UserSettings @relation(fields: [userId], references: [userId], onDelete: Cascade)

  state              String   @default("idle") // "idle" | "running" | "paused" | "cooldown"
  accumulatedSeconds Int      @default(0)      // Time accumulated before pause/cooldown
  startedAt          DateTime?                 // When current running period started
  pausedAt           DateTime?                 // When manually paused
  cooldownStartedAt  DateTime?                 // When cooldown period started
  lastActivityAt     DateTime @default(now())  // Last focus activity timestamp

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("pomodoro_sessions")
}

model ChatSession {
  id             String        @id @default(cuid())
  title          String?
  attentionRange String        @default("2h") // "30m" | "2h" | "1d" | "all"
  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages       ChatMessage[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([userId])
  @@map("chat_sessions")
}

model ChatMessage {
  id            String      @id @default(cuid())
  sessionId     String
  session       ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  role          String      // "user" | "assistant" | "tool"
  content       String      @db.Text
  status        String      @default("sent") // "sending" | "sent" | "typing" | "streaming" | "finished" | "error"
  errorMessage  String?
  // Tool-related fields (for role="tool" messages)
  toolCallId    String?     // ID linking tool call to tool result
  toolName      String?     // Name of the tool that was called
  // File attachments (for user messages)
  attachments   Json?       // Array of {filename, mimeType, size, data} objects
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([sessionId])
  @@map("chat_messages")
}

model Focus {
  id               String    @id @default(cuid())
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  item             String    // 2-3 word focus description
  keywords         String[]  // Historical keywords (max 10, then summarize)

  isActive         Boolean   @default(true)
  startedAt        DateTime  @default(now())
  endedAt          DateTime? // Set when drift detected or inactivity
  lastCalculatedAt DateTime  @default(now()) // For incremental processing
  lastActivityAt   DateTime  @default(now()) // For inactivity detection

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([userId])
  @@index([userId, isActive])
  @@index([lastCalculatedAt])
  @@map("focuses")
}

model Quiz {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  questions      Json     // Array of QuizQuestion objects
  activityDays   Int
  optionsCount   Int

  // Track what content was used to generate this quiz (for deduplication)
  contentHash    String?  // Hash of attention data used

  generatedAt    DateTime @default(now())
  completedAt    DateTime?

  answers        QuizAnswer[]
  result         QuizResult?

  @@index([userId])
  @@index([userId, generatedAt])
  @@map("quizzes")
}

model QuizAnswer {
  id             String   @id @default(cuid())
  quizId         String
  quiz           Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  questionIndex  Int
  selectedIndex  Int
  isCorrect      Boolean
  answeredAt     DateTime @default(now())

  @@unique([quizId, questionIndex])
  @@map("quiz_answers")
}

model QuizResult {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  quizId         String?  @unique
  quiz           Quiz?    @relation(fields: [quizId], references: [id], onDelete: SetNull)

  totalQuestions Int
  correctAnswers Int

  completedAt    DateTime @default(now())

  @@index([userId])
  @@index([userId, completedAt])
  @@map("quiz_results")
}

model Pulse {
  id        String   @id @default(cuid())
  userId    String
  message   String   @db.Text
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([userId, createdAt])
  @@map("pulses")
}

model AttentionInsight {
  id        String   @id @default(cuid())
  userId    String
  message   String   // Short 4-5 word summary like "You're reading about XYZ"
  sourceUrl String?  // URL where the attention was captured
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([userId, createdAt])
  @@map("attention_insights")
}

model AgentNudge {
  id          String    @id @default(cuid())
  userId      String
  type        String    // "doomscroll" | "distraction" | "break" | "focus_drift" | "encouragement"
  message     String    @db.Text
  context     Json      // Snapshot of what triggered it (domains, patterns, etc.)
  confidence  Float     // 0-1, how confident the agent was
  reasoning   String?   @db.Text // Why the agent decided to nudge

  // User response
  response    String?   // "acknowledged" | "false_positive" | "dismissed"
  respondedAt DateTime?

  createdAt   DateTime  @default(now())

  @@index([userId])
  @@index([userId, createdAt])
  @@index([userId, response]) // For learning from feedback
  @@map("agent_nudges")
}

// Note: Background jobs are now managed by pg-boss which creates its own tables in the pgboss schema


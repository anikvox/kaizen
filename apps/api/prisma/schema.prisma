generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String            @id @default(cuid())
  clerkId         String            @unique
  email           String            @unique
  name            String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  deviceTokens    DeviceToken[]
  websiteVisits   WebsiteVisit[]
  textAttentions  TextAttention[]
  imageAttentions ImageAttention[]
  audioAttentions AudioAttention[]
  youtubeAttentions YoutubeAttention[]
  settings        UserSettings?
  chatSessions    ChatSession[]

  @@map("users")
}

model DeviceToken {
  id        String   @id @default(cuid())
  token     String   @unique
  name      String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  lastUsedAt DateTime?

  @@map("device_tokens")
}

model WebsiteVisit {
  id        String   @id @default(cuid())
  url       String
  title     String
  metadata  Json     @default("{}")
  openedAt  DateTime
  closedAt  DateTime?
  activeTime Int     @default(0) // in milliseconds
  referrer  String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, url, openedAt])
  @@index([userId])
  @@index([url])
  @@map("website_visits")
}

model TextAttention {
  id        String   @id @default(cuid())
  url       String
  text      String   @db.Text
  wordsRead Int
  timestamp DateTime
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([url])
  @@index([timestamp])
  @@map("text_attentions")
}

model ImageAttention {
  id            String   @id @default(cuid())
  url           String
  src           String
  alt           String
  title         String
  width         Int
  height        Int
  hoverDuration Int      // in milliseconds
  confidence    Int      // 0-100
  timestamp     DateTime
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([url])
  @@index([timestamp])
  @@map("image_attentions")
}

model AudioAttention {
  id               String   @id @default(cuid())
  url              String
  src              String
  title            String
  duration         Float    // in seconds
  playbackDuration Int      // in milliseconds
  currentTime      Float    // in seconds
  confidence       Int      // 0-100
  timestamp        DateTime
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt        DateTime @default(now())

  @@index([userId])
  @@index([url])
  @@index([timestamp])
  @@map("audio_attentions")
}

model YoutubeAttention {
  id              String   @id @default(cuid())
  videoId         String?
  event           String   // "opened" | "caption" | "active-watch-time-update"
  title           String?
  channelName     String?
  url             String?
  caption         String?  @db.Text
  activeWatchTime Int?     // in milliseconds
  timestamp       DateTime
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([videoId])
  @@index([timestamp])
  @@map("youtube_attentions")
}

model UserSettings {
  id                            String   @id @default(cuid())
  userId                        String   @unique
  user                          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Cognitive Attention Settings
  cognitiveAttentionDebugMode   Boolean  @default(false)
  cognitiveAttentionShowOverlay Boolean  @default(false)
  // LLM Settings
  llmProvider                   String?  // "gemini" | "anthropic" | "openai" | null (system default)
  llmModel                      String?  // Selected model for the provider
  geminiApiKeyEncrypted         String?  @db.Text
  anthropicApiKeyEncrypted      String?  @db.Text
  openaiApiKeyEncrypted         String?  @db.Text
  createdAt                     DateTime @default(now())
  updatedAt                     DateTime @updatedAt

  @@map("user_settings")
}

model ChatSession {
  id             String        @id @default(cuid())
  title          String?
  attentionRange String        @default("2h") // "30m" | "2h" | "1d" | "all"
  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages       ChatMessage[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([userId])
  @@map("chat_sessions")
}

model ChatMessage {
  id            String      @id @default(cuid())
  sessionId     String
  session       ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  role          String      // "user" | "bot"
  content       String      @db.Text
  status        String      @default("sent") // "sending" | "sent" | "typing" | "streaming" | "finished" | "error"
  errorMessage  String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([sessionId])
  @@map("chat_messages")
}
